# QUICK:

ä½ è€Œå®¶æ‡‰è©²åšï¼š
Turn off cloudflare
npx supabase start --debug
æœ¬åœ°å…ˆè·‘ï¼ˆå””æ¸… data å°±ç”¨ï¼‰
supabase migration up
å¦‚æœ OKï¼Œå†æ¨ä¸Š remoteï¼š
npx supabase db push
å¦‚æœä½ å””ä»‹æ„æ¸…æœ¬åœ° dataï¼Œå¯ä»¥ç”¨ npx supabase db resetï¼Œä½†ä½ æ–‡ä»¶å¯«æ˜ã€Œå””æƒ³æ¸…å°±ç”¨ migration upã€ã€‚

æ‰€ä»¥ç­”æ¡ˆï¼šå…ˆ supabase migration upï¼Œä¹‹å¾Œå† npx supabase db pushã€‚

# Database & Migration Workflow

This project uses Supabase migrations as the single source of truth.

Never manually edit the remote database schema without a migration.

---

0. Baseline

---

Baseline migration file:

supabase/migrations/00000000000000_baseline.sql

This file represents the initial snapshot pulled from remote Supabase.

Do NOT edit this file after it is created.

---

1. Making a schema change (recommended)

---

Step 1: Create a new migration

npx supabase migration new <short_description>

Example:
npx supabase migration new add_activity_visibility

This creates a file like:
supabase/migrations/<timestamp>\_add_activity_visibility.sql

---

## Step 2: Write SQL in the migration file

Example SQL:

alter table public.activities
add column if not exists visibility text not null default 'public';

Use migrations for:

- tables
- columns
- indexes
- RLS policies
- functions
- triggers

---

## Step 3: Apply migrations locally

æŠŠ migrations apply åˆ° local supabase (Not cleaning data use this one)

supabase migration up

To clean the db from scratch:

npx supabase db reset

This will:

- Drop the local database
- Replay all migrations from scratch
- Verify migrations are reproducible

## ï¼ˆå¦‚æœä½ ä¿‚ç”¨ supabase db reset æœƒæ¸… dataï¼›ä½ è€Œå®¶å””æƒ³æ¸…å°±ç”¨ migration upã€‚ï¼‰

2. Alternative workflow: diff-based migration

---

If the local DB was modified manually:

npx supabase db diff -f <migration_name>

Example:
npx supabase db diff -f add_activity_visibility

This generates a migration from schema differences.

WARNING:
Always review the generated SQL carefully.
Policy order and extensions may need cleanup.

---

3. Push schema to remote Supabase

---

After local verification:

npx supabase db push

This applies new migrations to the remote Supabase database.

---

4. Rules & reminders

---

- Migrations are the source of truth
- Do not manually edit remote schema
- Always run db reset locally before pushing
- Commit migration files to git

---

6. Dump remote data to local (for QA)

---

This will pull data from the remote Supabase project and load it into local.

Prereqs:

- You are logged in to Supabase CLI
- You have the project ref

Commands:

1. Login + link (only once)
   npx supabase login
   npx supabase link --project-ref vvpkrbrirnfzdvyndmet

2. Dump remote data (data-only)
   npx supabase db dump --data-only -f /tmp/nearby_remote_data.sql

3. (Optional) Reset local DB if you want a clean import
   npx supabase db reset

4. Import into local DB
   psql "postgresql://postgres:postgres@127.0.0.1:54322/postgres" -f /tmp/nearby_remote_data.sql

5. Quick sanity check
   psql "postgresql://postgres:postgres@127.0.0.1:54322/postgres" -c "select count(\*) from public.activities;"

Tip:
Use the helper script:
scripts/dump_remote_to_local.sh

---

7. DB QA (quick checks)

---

See: .docs/QA_DB.md 5. Debugging checklist

---

If remote schema looks wrong:

- Check migration order
- Confirm migration was pushed
- Run supabase db diff to detect drift

If local schema is wrong:

- Run supabase db reset
- Verify baseline file
- Review migration SQL

ğŸ§ª å’æœ¬åœ°é»ç®—ï¼Ÿæˆ‘æƒ³ã€Œåæ‚”ã€å‘€
æœ¬åœ°ï¼ˆæœª push å» remoteï¼‰æœ‰ç‰¹æ¬Š

å¦‚æœä½  æœª supabase db pushï¼š

ä½ å¯ä»¥ï¼š

åˆªå€‹ migration

æ”¹ä½¢

npx supabase db reset

ğŸ‘‰ å› ç‚ºï¼š

æœ¬åœ° DB å¯ä»¥ç‚¸

ä½ ä¸€å€‹äººæ‰¿æ“”å¾Œæœ

âš ï¸ ä¸€æ—¦ push å» remoteï¼Œå‘¢å€‹ç‰¹æ¬Šå°±æ¶ˆå¤±ã€‚

ğŸ§© å¯¦æˆ°ä¾‹å­ï¼ˆä½ ä¸€ç‡å°±æ˜ï¼‰
ä½ åšå’—ï¼š
-- migration A
alter table activities add column visibility text;

ç™¼ç¾éŒ¯å’— â†’ æ­£ç¢ºåšæ³•ï¼š
npx supabase migration new remove_visibility

-- migration B
alter table activities drop column visibility;

ç„¶å¾Œï¼š

npx supabase db reset # local
npx supabase db push # remote
