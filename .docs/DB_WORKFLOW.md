# QUICK:

ä½ è€Œå®¶æ‡‰è©²åšï¼š
Turn off cloudflare
npx supabase start --debug
æœ¬åœ°å…ˆè·‘ï¼ˆå””æ¸… data å°±ç”¨ï¼‰
supabase migration up
å¦‚æœ OKï¼Œå†æ¨ä¸Š remoteï¼š
npx supabase db push
å¦‚æœä½ å””ä»‹æ„æ¸…æœ¬åœ° dataï¼Œå¯ä»¥ç”¨ npx supabase db resetï¼Œä½†ä½ æ–‡ä»¶å¯«æ˜ã€Œå””æƒ³æ¸…å°±ç”¨ migration upã€ã€‚

æ‰€ä»¥ç­”æ¡ˆï¼šå…ˆ supabase migration upï¼Œä¹‹å¾Œå† npx supabase db pushã€‚

# Database & Migration Workflow

# Database & Migration Workflowï¼ˆè³‡æ–™åº«èˆ‡é·ç§»æµç¨‹ï¼‰

This project uses Supabase migrations as the single source of truth.
æœ¬å°ˆæ¡ˆä»¥ Supabase migrations ä½œç‚ºå”¯ä¸€æº–ç¢ºä¾†æºã€‚

Never manually edit the remote database schema without a migration.
å””å¥½ç›´æ¥å–º remote æ‰‹å‹•æ”¹ schemaï¼Œä¸€å®šè¦ç”¨ migrationã€‚

---

0. Baseline
1. åŸºæº–

---

Baseline migration file:
åŸºæº– migration æª”æ¡ˆï¼š

supabase/migrations/00000000000000_baseline.sql

This file represents the initial snapshot pulled from remote Supabase.
å‘¢å€‹æª”æ¡ˆä¿‚å¾ remote Supabase æ‹‰è¿”åšŸå˜…åˆå§‹å¿«ç…§ã€‚

Do NOT edit this file after it is created.
å»ºç«‹å¾Œå””å¥½å†æ”¹ä½¢ã€‚

---

1. Making a schema change (recommended)
1. ä¿®æ”¹ schemaï¼ˆå»ºè­°åšæ³•ï¼‰

---

Step 1: Create a new migration
Step 1ï¼šå»ºç«‹æ–° migration

npx supabase migration new <short_description>

Example:
ä¾‹å­ï¼š
npx supabase migration new add_activity_visibility

This creates a file like:
æœƒå»ºç«‹é¡ä¼¼å‘¢å€‹æª”ï¼š
supabase/migrations/<timestamp>\_add_activity_visibility.sql

---

## Step 2: Write SQL in the migration file

## Step 2ï¼šå–º migration æª”æ¡ˆå¯« SQL

Example SQL:
ä¾‹å­ï¼š

alter table public.activities
add column if not exists visibility text not null default 'public';

Use migrations for:
ä»¥ä¸‹æ”¹å‹•éƒ½ç”¨ migrationsï¼š

- tables
- tablesï¼ˆè³‡æ–™è¡¨ï¼‰
- columns
- columnsï¼ˆæ¬„ä½ï¼‰
- indexes
- indexesï¼ˆç´¢å¼•ï¼‰
- RLS policies
- RLS policies
- functions
- functionsï¼ˆå‡½å¼ï¼‰
- triggers
- triggersï¼ˆè§¸ç™¼å™¨ï¼‰

---

## Step 3: Apply migrations locally

## Step 3ï¼šå–ºæœ¬åœ°å¥—ç”¨ migrations

æŠŠ migrations apply åˆ° local supabase (Not cleaning data use this one)
å°‡ migrations å¥—ç”¨åˆ°æœ¬åœ°ï¼ˆå””æ¸… data ç”¨å‘¢å€‹ï¼‰

supabase migration up

To clean the db from scratch:
å¦‚æœè¦æ¸…ç©ºé‡å»ºï¼š

npx supabase db reset

This will:
æœƒåšï¼š

- Drop the local database
- æ¸…æ‰æœ¬åœ° DB
- Replay all migrations from scratch
- é‡æ–°è·‘æ™’æ‰€æœ‰ migrations
- Verify migrations are reproducible
- é©—è­‰ migrations å¯é‡è¤‡

## ï¼ˆå¦‚æœä½ ä¿‚ç”¨ supabase db reset æœƒæ¸… dataï¼›ä½ è€Œå®¶å””æƒ³æ¸…å°±ç”¨ migration upã€‚ï¼‰

2. Alternative workflow: diff-based migration
3. å¦ä¸€ç¨®æµç¨‹ï¼šdiff-based migration

---

If the local DB was modified manually:
å¦‚æœæœ¬åœ° DB æ‰‹å‹•æ”¹éï¼š

npx supabase db diff -f <migration_name>

Example:
ä¾‹å­ï¼š
npx supabase db diff -f add_activity_visibility

This generates a migration from schema differences.
æœƒç”±å·®ç•°è‡ªå‹•ç”¢ç”Ÿ migrationã€‚

WARNING:
æ³¨æ„ï¼š
Always review the generated SQL carefully.
ä¸€å®šè¦ä»”ç´°æª¢æŸ¥è‡ªå‹•ç”Ÿæˆå˜… SQLã€‚
Policy order and extensions may need cleanup.
Policy é †åºåŒ extensions å¯èƒ½è¦æ¸…ç†ã€‚

---

3. Push schema to remote Supabase
4. æ¨é€ schema åˆ° remote Supabase

---

After local verification:
æœ¬åœ°ç¢ºèª OK å¾Œï¼š

npx supabase db push

This applies new migrations to the remote Supabase database.
æœƒå°‡æ–° migrations å¥—ç”¨åˆ° remoteã€‚

---

4. Rules & reminders
5. è¦å‰‡èˆ‡æé†’

---

- Migrations are the source of truth
- migrations ä¿‚å”¯ä¸€æº–ç¢ºä¾†æº
- Do not manually edit remote schema
- å””å¥½æ‰‹å‹•æ”¹ remote schema
- Always run db reset locally before pushing
- push å‰å»ºè­°æœ¬åœ°å…ˆ db reset
- Commit migration files to git
- è¨˜å¾— commit migration æª”

---

5. Dump remote data to local (for QA)
6. å¾ remote æŠ½è³‡æ–™è½æœ¬åœ°ï¼ˆåš QAï¼‰

---

This will pull data from the remote Supabase project and load it into local.
æœƒç”± remote æ‹‰è³‡æ–™è½æœ¬åœ°ã€‚

Prereqs:
å‰ç½®ï¼š

- You are logged in to Supabase CLI
- ä½ å·²ç™»å…¥ Supabase CLI
- You have the project ref
- ä½ æœ‰ project ref

Commands:
æŒ‡ä»¤ï¼š

1. Login + link (only once)
1. ç™»å…¥ + linkï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
   npx supabase login
   npx supabase link --project-ref vvpkrbrirnfzdvyndmet

1. Dump remote data (data-only)
1. åŒ¯å‡º remote dataï¼ˆåªè¦ dataï¼‰
   npx supabase db dump --data-only -f /tmp/nearby_remote_data.sql

1. (Optional) Reset local DB if you want a clean import
1. ï¼ˆå¯é¸ï¼‰å¦‚æœæƒ³ä¹¾æ·¨å°å…¥å…ˆ reset æœ¬åœ° DB
   npx supabase db reset

1. Import into local DB
1. å°å…¥æœ¬åœ° DB
   psql "postgresql://postgres:postgres@127.0.0.1:54322/postgres" -f /tmp/nearby_remote_data.sql

1. Quick sanity check
1. å¿«é€Ÿæª¢æŸ¥
   psql "postgresql://postgres:postgres@127.0.0.1:54322/postgres" -c "select count(\*) from public.activities;"

Tip:
æç¤ºï¼š
Use the helper script:
å¯ä»¥ç”¨è…³æœ¬ï¼š
scripts/dump_remote_to_local.sh

---

6. DB QA (quick checks)
7. DB QAï¼ˆå¿«é€Ÿæª¢æŸ¥ï¼‰

---

See: .docs/QA_DB.md 5. Debugging checklist
è©³è¦‹ï¼š.docs/QA_DB.md 5. Debugging checklist

---

If remote schema looks wrong:
å¦‚æœ remote schema æœ‰å•é¡Œï¼š

- Check migration order
- æª¢æŸ¥ migration é †åº
- Confirm migration was pushed
- ç¢ºèª migration æœ‰ push
- Run supabase db diff to detect drift
- ç”¨ supabase db diff æ‰¾ drift

If local schema is wrong:
å¦‚æœæœ¬åœ° schema æœ‰å•é¡Œï¼š

- Run supabase db reset
- è·‘ supabase db reset
- Verify baseline file
- æª¢æŸ¥ baseline æª”
- Review migration SQL
- æª¢æŸ¥ migration SQL

ğŸ§ª å’æœ¬åœ°é»ç®—ï¼Ÿæˆ‘æƒ³ã€Œåæ‚”ã€å‘€
æœ¬åœ°ï¼ˆæœª push å» remoteï¼‰æœ‰ç‰¹æ¬Š

å¦‚æœä½  æœª supabase db pushï¼š
ä½ å¯ä»¥ï¼š

åˆªå€‹ migration

æ”¹ä½¢

npx supabase db reset

ğŸ‘‰ å› ç‚ºï¼š
æœ¬åœ° DB å¯ä»¥ç‚¸
